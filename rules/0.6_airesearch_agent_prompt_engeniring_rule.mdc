---
description: 
globs: 
alwaysApply: false
---
# AI Research Agent Prompt Engineering Rule

## Описание
Это правило определяет стандарты и лучшие практики для формулирования промптов AI агентов в рамках воркфлоу анализа историй общения с клиентами. Правило обеспечивает последовательность и эффективность в создании промптов, которые генерируют структурированные и машиночитаемые выходные данные.

## Основные принципы структурирования промптов

### 1. Общие принципы
- **Системные промпты** должны содержать знания, фреймворки и справочные материалы
- **Пользовательские промпты** должны содержать конкретные задачи, входные данные и требования к выводу
- Элементы должны размещаться там, где они наиболее логично соответствуют своей функции

### 2. Правила размещения элементов

#### Элементы для системного промпта
- **Шаблоны и форматы**: JSON-структуры, форматы и шаблоны
- **Правила и руководства**: ограничения, принципы и методология
- **Примечания и глобальные ограничения**: требования к языку, общие ограничения
- **Анализ входных данных**: инструкции по проверке и валидации входных данных

#### Элементы для пользовательского промпта
- **Контейнеры данных**: входные данные, цитаты, фрагменты текста
- **Инструкции по задачам**: конкретные действия, шаги и процедуры
- **Требования к выводу**: форматы ответов, ожидаемые результаты

### 3. Структура промпта
- **Системный промпт**: Содержит основные инструкции, контекст и ограничения для AI модели.
- **Пользовательский промпт**: Содержит конкретный запрос или задачу.
- **Переменные**: Используйте синтаксис `{{#node_id.text#}}` для передачи данных между узлами.

## Анализ входных и выходных данных

### 1. Анализ входных данных
Каждый промпт должен включать тег `<InputValidation>` в системном промпте, который содержит:
- Проверку формата входных данных
- Валидацию структуры и полей
- Обработку специальных элементов (например, нумерации чанков, таймстемпов)

### 2. Формат выходных данных
Каждый промпт должен включать тег `<OutputFormat>` в системном промпте, который содержит:
- Точную спецификацию JSON-структуры в формате JSON minified
- Примеры правильного форматирования
- Критические поля, которые должны быть сохранены (например, chunk_id, timing)

### 3. Критические элементы для сохранения
Проверяй элементы промтов на сохранение в них критических элементов форматирования, прослеживаемых во всей цепочке промптов, например:
- **Нумерация чанков в формате X.Y**, где:
  - X - номер исходного текста
  - Y - номер чанка внутри текста
- **Таймстемпы и индикаторы говорящих** в формате (Speaker X | time) или (хх.yy.zz)
- **Структура JSON** с обязательными полями, соответствующими требованиям следующего узла в воркфлоу

## Формат вывода JSON Minified
Все промпты должны указывать формат вывода как JSON Minified для обеспечения машиночитаемости и последовательности между узлами воркфлоу. Это критически важно для правильной передачи данных между промптами.

### Требования к формату JSON Minified:
1. **Компактность**: Отсутствие пробелов, переносов строк и других форматирующих символов
2. **Полнота**: Включение всех необходимых полей и значений
3. **Валидность**: Соответствие стандарту JSON
4. **Консистентность**: Использование одинаковых имен полей и структур во всех связанных промптах

### Пример JSON Minified:
```
{"research_questions":[{"id":"1","text":"Main research question 1","quotes":[{"text":"Quote 1","respondent":"Name","timestamp":"00:15:30"}]}]}
```

## Консистентность инпутов-аутпутов в цепочке промптов

Для обеспечения корректной передачи данных между промптами необходимо соблюдать следующие правила:

1. **Согласованность структур данных**: 
   - Выходная структура JSON предыдущего промпта должна соответствовать ожидаемой входной структуре следующего промпта
   - Имена полей должны быть идентичными во всех связанных промптах
   - Типы данных должны быть согласованными (строки, числа, массивы, объекты)

2. **Проверка совместимости**:
   - Каждый промпт должен включать валидацию входных данных, соответствующую выходным данным предыдущего промпта
   - Промпты должны обрабатывать возможные несоответствия в структуре данных

3. **Документирование зависимостей**:
   - В каждом промпте должны быть указаны зависимости от предыдущих промптов
   - Должны быть документированы ожидаемые входные и выходные структуры данных

4. **Тестирование цепочки промптов**:
   - Перед внедрением необходимо тестировать всю цепочку промптов
   - Проверять корректность передачи данных между всеми узлами воркфлоу

## Использование специализированных правил для форматов JSON

Для обеспечения консистентности и полноты форматов JSON в различных этапах воркфлоу, используйте следующие специализированные правила:

1. **Для очистки и улучшения текста интервью**: 
   - Используйте правило `06_text_refinement_rule.mdc`, которое определяет структуру JSON для вывода очищенного текста
   - Обеспечивает сохранение номеров чанков, таймстемпов и индикаторов говорящих

2. **Для структурирования потребностей клиентов в формате JTBD**:
   - Используйте правило `05_jtbd_framework_rule.mdc`, которое определяет полную структуру Job Stories с 22 элементами
   - Обеспечивает полноту и согласованность формулировок потребностей

3. **Для верификации формулировок потребностей**:
   - Используйте правило `07_needs_formulation_verification_rule.mdc`, которое определяет структуру JSON для результатов верификации
   - Обеспечивает проверку точности и полноты формулировок

4. **Для распределения цитат по исследовательским вопросам**:
   - Используйте правило `13_quotes_distribution_rule.mdc`, которое определяет структуру JSON для распределения цитат
   - Обеспечивает корректное распределение цитат по вопросам и сохранение метаданных

5. **Для синтеза потребностей**:
   - Используйте правило `14_synthesis_rule.mdc`, которое определяет структуру JSON для синтеза потребностей
   - Обеспечивает группировку схожих потребностей и сохранение связей с респондентами

Эти правила содержат детальные примеры JSON-структур, которые должны использоваться в соответствующих этапах воркфлоу.

## Теги для структурирования промптов

### Системные теги
- `<Role>` - определяет роль AI-агента
- `<Rules>` - содержит правила обработки данных
- `<InputValidation>` - инструкции по проверке входных данных
- `<OutputFormat>` - спецификация формата вывода с примерами
- `<Examples>` - примеры входных и выходных данных
- `<ValidationCriteria>` - критерии для проверки результатов
- `<JobStoryStructure>` - структура Job Stories (если применимо)
- `<Note>` - важные примечания и ограничения

### Пользовательские теги
- `<Instructions>` - пронумерованные инструкции для выполнения
- `<InputText>` - входной текст для обработки
- `<PreviouslyIdentifiedProblems>` - проблемы, выявленные на предыдущих этапах
- `<IncomingJobStories>` - Job Stories для обработки
- `<OriginalTranscript>` - исходный транскрипт для сверки
- `<json_minified_output_schema>` - схема JSON для вывода

## Финальная проверка промптов

При создании или обновлении промптов необходимо проверить наличие следующих критических системных элементов, обеспечивающих связанность воркфлоу:

1. **Сохранение нумерации чанков X.Y** - проверить, что промпт явно требует сохранения формата нумерации
2. **Сохранение таймстемпов и индикаторов говорящих** - убедиться, что промпт требует сохранения этих элементов
3. **Точный формат JSON Minified** - проверить наличие конкретного примера JSON-структуры в минифицированном формате
4. **Проверка входных данных** - убедиться, что промпт включает инструкции по валидации входных данных
5. **Совместимость с последующими узлами** - проверить, что формат вывода соответствует требованиям следующего узла в воркфлоу
6. **Консистентность инпутов-аутпутов** - проверить, что выходные данные одного промпта корректно обрабатываются следующим промптом

## Примеры реструктуризации промптов

### НЕПРАВИЛЬНО (Исходное размещение)

#### Единый комбинированный промпт:
```
<prompt> 
For each problem/opportunity or user request and corresponding text fragments from the list {{#17398399439750.text#}}, formulate Job stories in the following format: 
- Text number <text_number> 
- Problem: <brief title of the current problem> 
- Problem description: <description of the current situation> 
- Quote: <supporting fragment> (respondent's name, timing) 
- Negative emotional state: <how they feel now when the problem is unresolved> 
- Want (Avoidance undesired result): <what they want to "escape from," related to the negative state> 
- Want (Achievement desired result): <specific desired result the user wants to achieve> 
- So that: <long-term goal/desired result> 
- Desired positive emotional state: <how they want to feel> 
- Importance of need: <rating 1-10> 
- Frequency: <how often they encounter the problem> 
- Events by which they will know the result is achieved (e.g., ideal day) 
- Achievement deadline: <desired time frame for obtaining the result>
- Achievement criteria: <how they will know the result is achieved>
- Previous solutions and products: <what the respondent used before>
- Satisfaction with past solutions: <rating for each 1-10> 
- Cost of past solutions: <how much has already been paid> 
- Reasons for dissatisfaction with solutions: <triggers for refusal>
- Consequences/costs associated with not solving the problem: <time, money, energy> 
- Drivers: <what inspires/motivates changes and achieving the desired result> 
- Barriers: <what prevents achieving the result> 
- Ideal solution: <ideal solution from the client's perspective>
- Respondent's name: <name of the respondent>

0. RULES FOR FORMULATING DESIRED/UNDESIRED RESULTS IN JOB STORIES: 
Achievement/Avoidance results must be: 
- Timeless and solution-independent (the need remains even when solutions change) 
- Predictable/manageable (reflects what the user wants to achieve/avoid without specific numbers) 
- Unambiguous in formulation 
- Formulated from the user's responsibility 
- Simply and clearly stated 

Structure of result formulations: 
Direction of change + Measure of change (without specific numbers) + Object of control 

IMPORTANT: Do not include solutions or methods of achieving results in the formulation of results 

1. Formulate Job Stories for each problem and corresponding quote without making assumptions from the list in the proposed structure 
2. Do not make up missing data for filling out job stories, only take from {{#17310716440470.text#}} 
3. Analyze and provide the output in the following structure: 

<json_minified_output_schema> 
{"job_story":{"text_number":"1","problem":"Краткое название","problem_description":"Описание ситуации","quote":{"text":"Цитата","respondent":"Имя","timing":"00:15:30"},"negative_emotional_state":"Состояние","want_avoidance":"Избегание","want_achievement":"Достижение","so_that":"Цель","desired_emotional_state":"Желаемое состояние","importance":8,"frequency":"Частота","achievement_events":"События","achievement_deadline":"Сроки","achievement_criteria":"Критерии","previous_solutions":["Решение 1"],"satisfaction_with_solutions":[6],"cost_of_solutions":"Стоимость","dissatisfaction_reasons":["Причина 1"],"consequences":"Последствия","drivers":["Драйвер 1"],"barriers":["Барьер 1"],"ideal_solution":"Решение","respondent_name":"Имя"}}
</json_minified_output_schema> 

Note: Provide all output in English. If source text is in another language, translate before analysis. 
</prompt>
```

### ПРАВИЛЬНО (Реструктурированное размещение)

#### Системный промпт:
```
<Role>
You are a specialized analyst who formulates Job Stories based on identified problems and quotes from interview transcripts.
</Role>

<Rules>
- Results should be:
  - Timeless: Valid regardless of specific solutions.
  - Solution-independent: Focus on needs, not tools.
  - Predictable: Clear and manageable outcomes.
  - User-focused: Written from the user's perspective.
  - Simple: Concise and easy to understand.
  - Structure: Direction of change + Measure of change + Object of control (e.g., "reduce time spent on task completion").
  - Note: Avoid mentioning specific solutions in the results.
</Rules>

<InputValidation>
Check that input data contains:
- Problem descriptions with titles
- Supporting quotes with respondent names and timing
- Ensure all text fragments are properly formatted
</InputValidation>

<JTBDStructure>
Job Stories must include the following elements:
1. Text number - номер анализируемого текста
2. Problem - краткое название текущей проблемы
3. Problem description - описание текущей ситуации
4. Quote - подтверждающий фрагмент из интервью (имя респондента, таймкод)
5. Negative emotional state - как клиент чувствует себя, когда проблема не решена
6. Want (Avoidance undesired result) - от чего клиент хочет "убежать"
7. Want (Achievement desired result) - конкретный желаемый результат
8. So that - долгосрочная цель/желаемый результат
9. Desired positive emotional state - как клиент хочет себя чувствовать
10. Importance of need - оценка важности от 1 до 10
11. Frequency - как часто клиент сталкивается с проблемой
12. Achievement events - события, по которым клиент поймет, что результат достигнут
13. Achievement deadline - желаемые сроки получения результата
14. Achievement criteria - как клиент узнает, что результат достигнут
15. Previous solutions - что респондент использовал ранее
16. Satisfaction with past solutions - оценка для каждого решения от 1 до 10
17. Cost of past solutions - сколько уже было заплачено
18. Dissatisfaction reasons - триггеры для отказа
19. Consequences - последствия нерешения проблемы
20. Drivers - что вдохновляет/мотивирует изменения
21. Barriers - что препятствует достижению результата
22. Ideal solution - идеальное решение с точки зрения клиента
23. Respondent's name - имя респондента
</JTBDStructure>

<OutputFormat>
The output must be in JSON Minified format with the following structure:

{"job_stories":[{"text_number":"X.Y","problem":"Краткое название проблемы","problem_description":"Описание текущей ситуации","quote":{"text":"Цитата из интервью","respondent":"Имя респондента","timing":"XX:YY:ZZ"},"negative_emotional_state":"Как клиент чувствует себя сейчас","want_avoidance":"От чего клиент хочет избавиться","want_achievement":"Чего клиент хочет достичь","so_that":"Долгосрочная цель","desired_emotional_state":"Как клиент хочет себя чувствовать","importance":N,"frequency":"Частота","achievement_events":"События, по которым клиент поймет, что результат достигнут","achievement_deadline":"Желаемые сроки","achievement_criteria":"Как клиент узнает, что результат достигнут","previous_solutions":["Решение 1","Решение 2"],"satisfaction_with_solutions":[N,N],"cost_of_solutions":"Стоимость решений","dissatisfaction_reasons":["Причина 1","Причина 2"],"consequences":"Последствия нерешения проблемы","drivers":["Драйвер 1","Драйвер 2"],"barriers":["Барьер 1","Барьер 2"],"ideal_solution":"Описание идеального решения","respondent_name":"Имя респондента"}]}
</OutputFormat>

<Note>
All output must be in English. Translate any non-English source text before analysis.
</Note>

#### Пользовательский промпт:
```
<Instructions>
1. Проанализируйте каждую проблему или возможность во входных данных и сформулируйте полную Job Story.
2. Используйте только информацию из входных данных, не делайте предположений.
3. Для каждой проблемы заполните все 23 элемента структуры Job Story.
4. Убедитесь, что формулировки желаемых и нежелаемых результатов соответствуют правилам:
   - Вневременные и независимые от решения
   - Предсказуемые/управляемые
   - Однозначные в формулировке
   - Сформулированные с точки зрения ответственности пользователя
   - Простые и ясные
5. Верните результат в структуре OutputFormat в формате JSON Minified, указанном в системном промпте.
</Instructions>
